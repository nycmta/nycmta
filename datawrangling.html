<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="William M. Donovan (wd2328), Hantang Qin (hq2229), Yongyan Liu (yl6107), Yijun Wang (yw4664), Heng Hu (hh2648)" />

<meta name="date" content="2025-11-13" />

<title>Data Wrangling</title>

<script src="site_libs/header-attrs-2.30/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.13.2/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>






<link rel="stylesheet" href="styles.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">NYC Subway & Weather</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="data.html">Data</a>
</li>
<li>
  <a href="datawrangling.html">Data Wrangling</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Data Wrangling</h1>
<h4 class="author">William M. Donovan (wd2328), Hantang Qin (hq2229),
Yongyan Liu (yl6107), Yijun Wang (yw4664), Heng Hu (hh2648)</h4>
<h4 class="date">2025-11-13</h4>

</div>


<div id="raw-data" class="section level2">
<h2>Raw Data</h2>
<pre class="r"><code>path_rid_2024 &lt;- &quot;data/mta_ridership_full/ridership_2024_manhattan.csv&quot;
path_rid_2025 &lt;- &quot;data/mta_ridership_full/ridership_2025_manhattan.csv&quot;
path_weather &lt;- &quot;data/weather/central_park_weather_wide.csv&quot;
path_events &lt;- &quot;data/events/nyc_large_events_2024_2025.csv&quot;
path_stations &lt;- &quot;data/stations/mta_station_complexes.csv&quot;

rid24 &lt;- vroom::vroom(path_rid_2024, show_col_types = FALSE)
rid25 &lt;- vroom::vroom(path_rid_2025, show_col_types = FALSE)
weather &lt;- readr::read_csv(path_weather, show_col_types = FALSE)
events &lt;- vroom::vroom(path_events, show_col_types = FALSE)
stations &lt;- readr::read_csv(path_stations, show_col_types = FALSE)

rid &lt;- bind_rows(rid24, rid25) %&gt;%
clean_names() %&gt;%
mutate(
transit_timestamp = ymd_hms(transit_timestamp, quiet = TRUE),
date = as_date(transit_timestamp),
hour = hour(transit_timestamp)
) %&gt;%
    select(station_complex_id, station_complex, borough, transit_timestamp, date, hour, total_ridership)

weather &lt;- weather %&gt;%
clean_names() %&gt;%
mutate(
date = as_date(date),
tmax = as.numeric(tmax),
prcp = as.numeric(prcp),
snow = as.numeric(snow)
) %&gt;%
select(date, tmax, prcp, snow) %&gt;%
arrange(date)


events &lt;- events %&gt;%
clean_names() %&gt;%
mutate(
start_dt = ymd_hms(start_date_time, quiet = TRUE),
end_dt = ymd_hms(end_date_time, quiet = TRUE),
event_borough = str_to_lower(event_borough)
) %&gt;%
filter(!is.na(start_dt), !is.na(end_dt), end_dt &gt;= start_dt)

stations &lt;- stations %&gt;%
clean_names() %&gt;%
filter(str_to_lower(borough) == &quot;manhattan&quot;, !is.na(latitude), !is.na(longitude))</code></pre>
</div>
<div id="build-station-hour-panel" class="section level2">
<h2>Build Station-Hour Panel</h2>
<pre class="r"><code>panel_station_hour &lt;- rid %&gt;%
select(station_complex_id, station_complex, date, hour, total_ridership) %&gt;%
arrange(station_complex_id, date, hour)

hour_cov &lt;- panel_station_hour %&gt;%
group_by(station_complex_id, date) %&gt;%
summarize(hours_present = n_distinct(hour), .groups = &quot;drop&quot;)</code></pre>
</div>
<div id="build-station-day-aggregate" class="section level2">
<h2>Build Station-Day Aggregate</h2>
<pre class="r"><code>panel_station_day &lt;- panel_station_hour %&gt;%
group_by(station_complex_id, station_complex, date) %&gt;%
summarize(
entries_day = sum(total_ridership, na.rm = TRUE),
.groups = &quot;drop&quot;
) %&gt;%
left_join(hour_cov, by = c(&quot;station_complex_id&quot;,&quot;date&quot;)) %&gt;%
mutate(hours_present = replace_na(hours_present, 0L))</code></pre>
</div>
<div id="merge-weather-create-heatwave-storm" class="section level2">
<h2>Merge Weather &amp; Create Heatwave / Storm</h2>
<pre class="r"><code>panel_station_day &lt;- panel_station_day %&gt;%
left_join(weather, by = &quot;date&quot;) %&gt;%
arrange(station_complex_id, date) %&gt;%
group_by(station_complex_id) %&gt;%
mutate(
heat_day = if_else(!is.na(tmax) &amp; tmax &gt;= params$heat_threshold_f, 1L, 0L),
heat_roll = slide_int(heat_day, sum, .before = params$heat_consec_days - 1, .complete = TRUE),
heatwave = if_else(!is.na(heat_roll) &amp; heat_roll &gt;= params$heat_consec_days, 1L, 0L),
storm = if_else(!is.na(prcp) &amp; prcp &gt;= params$storm_threshold_in, 1L, 0L),
weather_missing = as.integer(is.na(tmax) | is.na(prcp))
) %&gt;%
ungroup()</code></pre>
</div>
<div id="event-to-nearest-station" class="section level2">
<h2>Event to Nearest Station</h2>
<pre class="r"><code>library(tidygeocoder)
library(dplyr)
library(stringr)
library(readr)
library(purrr)
library(lubridate)

suppressPackageStartupMessages({
  library(dplyr); library(stringr); library(readr); library(purrr); library(lubridate)
  library(sf); library(janitor)
  has_tidygeocoder &lt;- requireNamespace(&quot;tidygeocoder&quot;, quietly = TRUE)
  if (!has_tidygeocoder) { library(httr); library(jsonlite) }
})

event_radius_m &lt;- tryCatch(params$event_radius_m, error = function(e) 800)

events_raw &lt;- readr::read_csv(
  &quot;data/events/nyc_large_events_2024_2025.csv&quot;,
  col_types = cols(.default = col_guess(), event_id = col_character()),
  show_col_types = FALSE
)

events_manhattan &lt;- events_raw %&gt;%
  mutate(
    event_borough = str_to_lower(event_borough),
    start_dt = ymd_hms(start_date_time, quiet = TRUE),
    end_dt   = ymd_hms(end_date_time, quiet = TRUE)
  ) %&gt;%
  filter(!is.na(start_dt), !is.na(end_dt), end_dt &gt;= start_dt) %&gt;%
  filter(is.na(event_borough) | str_detect(event_borough, &quot;manhattan&quot;))

focus_types &lt;- c(&quot;parade&quot;, &quot;athletic&quot;, &quot;race&quot;, &quot;tour&quot;, &quot;street&quot;, &quot;block&quot;, &quot;festival&quot;, &quot;fair&quot;)
events_focus &lt;- events_manhattan %&gt;%
  filter(!is.na(event_type)) %&gt;%
  filter(purrr::reduce(focus_types, \(acc, key) acc | str_detect(str_to_lower(event_type), key), .init = FALSE)) %&gt;%
  distinct(event_id, .keep_all = TRUE) %&gt;%
  mutate(
    query = if_else(
      is.na(event_location) | str_trim(event_location) == &quot;&quot;,
      paste0(event_name, &quot;, Manhattan, NY&quot;),
      paste0(event_location, &quot;, Manhattan, NY&quot;)
    )
  )

cache_path &lt;- &quot;data/events/nyc_large_events_geocoded.csv&quot;
if (file.exists(cache_path)) {
  geo_cache &lt;- readr::read_csv(
    cache_path,
    col_types = cols(.default = col_guess(), event_id = col_character()),
    show_col_types = FALSE
  )
} else {
  dir.create(&quot;data/events&quot;, showWarnings = FALSE, recursive = TRUE)
  geo_cache &lt;- tibble(event_id = character(), lon = numeric(), lat = numeric())
}

to_geocode &lt;- events_focus %&gt;%
  anti_join(geo_cache, by = &quot;event_id&quot;) %&gt;%
  select(event_id, query)


if (nrow(to_geocode) &gt; 0) {
  if (has_tidygeocoder) {
    library(tidygeocoder)
    batch_size &lt;- 1000
    batches &lt;- split(to_geocode, (seq_len(nrow(to_geocode)) - 1) %/% batch_size)

    results &lt;- purrr::map(batches, function(chunk) {
      g1 &lt;- chunk %&gt;%
        geocode(address = query, method = &quot;arcgis&quot;, lat = lat, long = lon,
                full_results = FALSE, timeout = 20)

      need_osm &lt;- g1 %&gt;% filter(is.na(lat) | is.na(lon))
      if (nrow(need_osm) &gt; 0) {
        g2 &lt;- need_osm %&gt;%
          geocode(address = query, method = &quot;osm&quot;, lat = lat2, long = lon2,
                  full_results = FALSE, timeout = 30)
        g1 &lt;- g1 %&gt;%
          left_join(g2 %&gt;% select(event_id, lat2, lon2), by = &quot;event_id&quot;) %&gt;%
          mutate(
            lat = if_else(is.na(lat), lat2, lat),
            lon = if_else(is.na(lon), lon2, lon)
          ) %&gt;%
          select(-lat2, -lon2)
      }
      g1 %&gt;% select(event_id, lon, lat)
    })

    geo_new &lt;- bind_rows(results)
  } else {
    osm_geocode_one &lt;- function(q) {
      url &lt;- &quot;https://nominatim.openstreetmap.org/search&quot;
      resp &lt;- httr::GET(
        url,
        query = list(q = q, format = &quot;json&quot;, addressdetails = 0, limit = 1),
        httr::add_headers(`User-Agent` = &quot;p8105-project-wrangling/1.0 (email@example.com)&quot;)
      )
      if (httr::http_error(resp)) return(c(lon = NA_real_, lat = NA_real_))
      txt &lt;- httr::content(resp, as = &quot;text&quot;, encoding = &quot;UTF-8&quot;)
      js &lt;- tryCatch(jsonlite::fromJSON(txt), error = function(e) NULL)
      if (is.null(js) || length(js) == 0) return(c(lon = NA_real_, lat = NA_real_))
      c(lon = suppressWarnings(as.numeric(js$lon[1])), lat = suppressWarnings(as.numeric(js$lat[1])))
    }

    geo_new &lt;- purrr::map_dfr(seq_len(nrow(to_geocode)), function(i){
      out &lt;- tryCatch(osm_geocode_one(to_geocode$query[i]), error = function(e) c(lon=NA_real_, lat=NA_real_))
      Sys.sleep(1.05) 
      tibble(event_id = to_geocode$event_id[i], lon = out[&quot;lon&quot;], lat = out[&quot;lat&quot;])
    })
  }

  geo_cache2 &lt;- geo_cache %&gt;%
    bind_rows(geo_new) %&gt;%
    mutate(
      lon = if_else(lon &lt; -75 | lon &gt; -72, NA_real_, lon),
      lat = if_else(lat &lt; 40  | lat &gt; 41,  NA_real_, lat)
    ) %&gt;%
    distinct(event_id, .keep_all = TRUE)

  readr::write_csv(geo_cache2, cache_path)
} else {
  geo_cache2 &lt;- geo_cache
}

events_focus_geo &lt;- events_focus %&gt;%
  left_join(geo_cache2, by = &quot;event_id&quot;)

evt_geo_ok &lt;- events_focus_geo %&gt;%
  filter(!is.na(lon), !is.na(lat)) %&gt;%
  mutate(
    start_hr = floor_date(start_dt, &quot;hour&quot;),
    end_hr   = ceiling_date(end_dt, &quot;hour&quot;)
  )

if (nrow(evt_geo_ok) == 0) {
  events_station_hour &lt;- tibble(station_complex_id=character(), date=as.Date(character()), hour=integer(), event_hour=integer())
} else {
  stations &lt;- readr::read_csv(&quot;data/stations/mta_station_complexes.csv&quot;, show_col_types = FALSE) %&gt;%
    janitor::clean_names() %&gt;%
    filter(str_to_lower(borough) == &quot;manhattan&quot;, !is.na(latitude), !is.na(longitude))

  stn_sf &lt;- st_as_sf(stations, coords = c(&quot;longitude&quot;,&quot;latitude&quot;), crs = 4326) %&gt;%
    st_transform(2263) 
  evt_sf &lt;- st_as_sf(evt_geo_ok, coords = c(&quot;lon&quot;,&quot;lat&quot;), crs = 4326) %&gt;%
    st_transform(2263)

  near_idx &lt;- st_nearest_feature(evt_sf, stn_sf)
  dist_ft  &lt;- st_distance(evt_sf, stn_sf[near_idx,], by_element = TRUE)
  dist_m   &lt;- as.numeric(dist_ft) * 0.3048

  evt_joined &lt;- evt_geo_ok %&gt;%
    mutate(
      station_complex_id = stn_sf$station_complex_id[near_idx],
      dist_m = dist_m
    ) %&gt;%
    filter(dist_m &lt;= event_radius_m) %&gt;%
    select(event_id, station_complex_id, start_hr, end_hr, dist_m)

  events_station_hour &lt;- purrr::map_dfr(seq_len(nrow(evt_joined)), function(i){
    tibble(
      station_complex_id = evt_joined$station_complex_id[i],
      hour_ts = seq(evt_joined$start_hr[i], evt_joined$end_hr[i], by = &quot;1 hour&quot;)
    )
  }) %&gt;%
    mutate(date = as_date(hour_ts), hour = hour(hour_ts), event_hour = 1L) %&gt;%
    distinct(station_complex_id, date, hour, .keep_all = TRUE) %&gt;%
    select(station_complex_id, date, hour, event_hour)
}

panel_station_hour &lt;- panel_station_hour %&gt;%
  left_join(events_station_hour, by = c(&quot;station_complex_id&quot;,&quot;date&quot;,&quot;hour&quot;)) %&gt;%
  mutate(event_hour = if_else(is.na(event_hour), 0L, event_hour))

event_day_by_station &lt;- panel_station_hour %&gt;%
  group_by(station_complex_id, date) %&gt;%
  summarize(event_day = as.integer(any(event_hour == 1L)), .groups = &quot;drop&quot;)

panel_station_day &lt;- panel_station_day %&gt;%
  left_join(event_day_by_station, by = c(&quot;station_complex_id&quot;,&quot;date&quot;)) %&gt;%
  mutate(event_day = if_else(is.na(event_day), 0L, event_day))</code></pre>
</div>
<div id="addition-of-holidays" class="section level2">
<h2>Addition of Holidays</h2>
<pre class="r"><code># Generate US federal holidays for 2024-2025
holidays = 
  tibble(
    date = as.Date(holidayNYSE(2024:2025)),
    is_holiday = &quot;Yes&quot;
  )

# Join with dataset
panel_station_day = 
  left_join(panel_station_day, holidays, by = &quot;date&quot;) |&gt;
  mutate(
    is_holiday = case_match(
      is_holiday,
      NA  ~ &quot;No&quot;,
      &quot;Yes&quot; ~ &quot;Yes&quot;
    )
  )</code></pre>
</div>
<div id="baseline-relative-change" class="section level2">
<h2>Baseline &amp; Relative Change</h2>
<pre class="r"><code>panel_station_day &lt;- panel_station_day %&gt;%
mutate(
dow = wday(date, label = TRUE, week_start = 1),  # Mon=1
month = month(date)
)

baseline_sd &lt;- panel_station_day %&gt;%
group_by(station_complex_id, dow, month) %&gt;%
summarize(baseline_sd = median(entries_day, na.rm = TRUE), .groups = &quot;drop&quot;)

panel_station_day &lt;- panel_station_day %&gt;%
left_join(baseline_sd, by = c(&quot;station_complex_id&quot;,&quot;dow&quot;,&quot;month&quot;)) %&gt;%
mutate(
pct_change = log( (entries_day + 1) / (baseline_sd + 1) )
)

baseline_sh &lt;- panel_station_hour %&gt;%
mutate(
dow = wday(date, label = TRUE, week_start = 1),
month = month(date)
) %&gt;%
group_by(station_complex_id, dow, month, hour) %&gt;%
summarize(baseline_sh = median(total_ridership, na.rm = TRUE), .groups = &quot;drop&quot;)

panel_station_hour &lt;- panel_station_hour %&gt;%
mutate(
dow = wday(date, label = TRUE, week_start = 1),
month = month(date)
) %&gt;%
left_join(baseline_sh, by = c(&quot;station_complex_id&quot;,&quot;dow&quot;,&quot;month&quot;,&quot;hour&quot;)) %&gt;%
mutate(
hourly_pct_change = log( (total_ridership + 1) / (baseline_sh + 1) )
)</code></pre>
</div>
<div id="outputs" class="section level2">
<h2>Outputs</h2>
<pre class="r"><code>if (isTRUE(params$write_outputs)) {
  out_dir &lt;- params$outputs_dir %||% &quot;data/derived&quot;
  dir.create(out_dir, showWarnings = FALSE, recursive = TRUE)

  req_hrs &lt;- params$require_hour_coverage %||% 20
  keep_sd &lt;- panel_station_day %&gt;%
    mutate(keep = hours_present &gt;= req_hrs)
  panel_station_day_filt &lt;- keep_sd %&gt;% filter(keep) %&gt;% select(-keep)

  station_lookup &lt;- panel_station_hour %&gt;%
    distinct(station_complex_id, station_complex) %&gt;%
    arrange(station_complex_id) %&gt;%
    mutate(station_id = as.integer(factor(station_complex_id)))
  date_lookup &lt;- panel_station_hour %&gt;%
    distinct(date) %&gt;%
    arrange(date) %&gt;%
    mutate(date_id = as.integer(factor(date)))
  hour_lookup &lt;- tibble(hour = 0:23) %&gt;%
    mutate(hour_id = hour + 1L)

  panel_station_day_idx &lt;- panel_station_day_filt %&gt;%
    left_join(station_lookup, by = c(&quot;station_complex_id&quot;,&quot;station_complex&quot;)) %&gt;%
    left_join(date_lookup, by = &quot;date&quot;) %&gt;%
    select(station_id, date_id, everything())

  panel_station_hour_idx &lt;- panel_station_hour %&gt;%
    left_join(station_lookup, by = c(&quot;station_complex_id&quot;,&quot;station_complex&quot;)) %&gt;%
    left_join(date_lookup, by = &quot;date&quot;) %&gt;%
    left_join(hour_lookup, by = &quot;hour&quot;) %&gt;%
    select(station_id, date_id, hour_id, everything())

  station_summ &lt;- panel_station_day_idx %&gt;%
    summarize(
      days = n(),
      heatwave_days = sum(heatwave == 1L, na.rm = TRUE),
      storm_days = sum(storm == 1L, na.rm = TRUE),
      event_days = sum(event_day == 1L, na.rm = TRUE),
      median_entries = median(entries_day, na.rm = TRUE),
      .by = c(station_id, station_complex_id, station_complex)
    ) %&gt;%
    mutate(
      pct_heatwave = heatwave_days / pmax(days, 1),
      pct_storm = storm_days / pmax(days, 1),
      pct_event = event_days / pmax(days, 1)
    ) %&gt;%
    arrange(desc(median_entries))

  arrow::write_parquet(panel_station_day_filt,  file.path(out_dir, &quot;panel_station_day.parquet&quot;))
  arrow::write_parquet(panel_station_hour,      file.path(out_dir, &quot;panel_station_hour.parquet&quot;))
  arrow::write_parquet(panel_station_day_idx,   file.path(out_dir, &quot;panel_station_day_indexed.parquet&quot;))
  arrow::write_parquet(panel_station_hour_idx,  file.path(out_dir, &quot;panel_station_hour_indexed.parquet&quot;))

  readr::write_csv(station_lookup,         file.path(out_dir, &quot;station_lookup.csv&quot;))
  readr::write_csv(date_lookup,            file.path(out_dir, &quot;date_lookup.csv&quot;))
  readr::write_csv(hour_lookup,            file.path(out_dir, &quot;hour_lookup.csv&quot;))
  readr::write_csv(station_summ,           file.path(out_dir, &quot;station_summary.csv&quot;))
}</code></pre>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("show" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
